(function(){
	chrome.extension.sendMessage({greeting: "query"}, function(response) {
		if(response.script_function == "on") {
			var a=document.location.href;

			if(null!=document.getElementById("Cbo_LX"))
				document.getElementById("Cbo_LX").value="\u5b66\u751f";
			else if(-1!=a.indexOf("stdgl/xkgl/ptxk/Web_ptxk_Main.aspx"))
				document.getElementById("RtMod1_Lb_title").setAttribute("href","/stdgl/xkgl/ptxk/Web_zgd_ptxk_new.aspx"),
				document.getElementById("RtMod3_Lb_title").setAttribute("href","/stdgl/xkgl/ptxk/Web_zgd_ptxk_tbx.aspx");
			else if(-1!=a.indexOf("stdgl/xkgl/zyxxk/Web_xsxxkc_main.aspx"))
				document.getElementById("RtMod1_Lb_title").setAttribute("href","/stdgl/xkgl/zyxxk/Web_xsxxkc_select.aspx"),
				document.getElementById("RtMod2_Lb_title").setAttribute("href","/stdgl/xkgl/zyxxk/web_xsxxkc_tbx.aspx"),
				document.getElementById("Rtmod4_Lb_title").setAttribute("href","/stdgl/xkgl/zyxxk/web_xsxxkc_tbx_2.aspx");
			/*else if(-1!=a.indexOf("/stdgl/xkgl/gxk/Web_GXK_Main.aspx"))
				document.getElementById("RtMod1_Lb_title").setAttribute("href","/stdgl/xkgl/gxk/Web_gxk_zyselect.aspx");*/
			else if(-1!=a.indexOf("/stdgl/stdgl_index.aspx"))
				document.getElementById("HEADER4_Lb_title").setAttribute("href","/stdgl/xkgl/tyxk/web_std_tyktbx.aspx");
			else if(-1!=a.indexOf("/stdgl/xkgl/gxk/Web_GXK_Main.aspx"))
				document.getElementById("RtMod1_Lb_title").setAttribute("href","javascript:if(confirm('目前插件只能实现提前看公选课，不能选，请注意')){window.location.href='/stdgl/xkgl/gxk/Web_std_gxk2013.aspx';}");
			else if(-1!=a.indexOf("/stdgl/xkgl/gxk/Web_gxk_zyselect2013.aspx"))
				document.getElementById("HEADER4_Lb_title").setAttribute("href","/stdgl/xkgl/tyxk/web_std_tyktbx.aspx");
			///stdgl/xkgl/tyxk/web_std_tyktbx.aspx
			///stdgl/xkgl/gxk/Web_std_gxk2013.aspx
			///stdgl/xkgl/gxk/Web_GXK_Main.aspx
			else if(-1!=a.indexOf("stdgl/cxxt/cjcx/Cjcx_Xsgrcj.aspx")){
				console.log(response.grade_term);
				grade_term = response.grade_term;
			
				if(""==document.getElementById("ddlXq").value)
					document.getElementById("ddlXq").value=grade_term,
					document.getElementById("ddlKc").value="\uff1d\u6240\u6709\u8bfe\u7a0b\uff1d",
					document.getElementById("Button1").click();
				a=document.createElement("script");
				a.setAttribute("type","text/javascript");
				a.innerHTML="function calGPA(withPE) { var scoreTable = document.getElementById('DataGrid1'); if (scoreTable != null) { var totalGrade = 0, totalSum = 0; for (var i = 1; i < scoreTable.rows.length; i++) { var courseName = scoreTable.rows[i].cells[1].innerHTML.replace(/(<([^>]+)>)/gi, \"\"), courseType = scoreTable.rows[i].cells[2].innerHTML.replace(/(<([^>]+)>)/gi, \"\"), forScore = scoreTable.rows[i].cells[3].innerHTML.replace(/(<([^>]+)>)/gi, \"\"), forGrade = scoreTable.rows[i].cells[5].innerHTML.replace(/(<([^>]+)>)/gi, \"\"); if (forScore == '\u514d\u4fee') { cell.innerHTML='<input type=\"checkbox\" id=\"course\"'+i+'onclick=\"javascript:calGPA('+withPE+');\"/>'; continue; } if(!document.getElementById('course'+i).checked){ continue; } if (isNaN(forScore)) { switch (forScore) { case '\u4f18\u79c0': forScore = 4.5; break; case '\u826f\u597d': forScore = 3.5; break; case '\u4e2d\u7b49': forScore = 2.5; break; case '\u53ca\u683c': forScore = 1.5; break; default: forScore = 0.0; } } else { forScore = (forScore >= 60) ? ((forScore - 50) / 10.0) : 0.0; } forGrade = forGrade * 1.0; totalGrade += (forGrade); totalSum += (forGrade * forScore); } var gpa = (totalSum / totalGrade).toFixed(3); if (!isNaN(gpa)) { var scoreHTML = '</br><font style=\"color:#FFFFFF;background-color:#006699\">\u672c\u9875\u5e73\u5747\u7ee9\u70b9:' + gpa + '</font>'; document.getElementById('Table3').rows[0].cells[0].innerHTML = '<span id=\"Label1\"><font color=\"#0000C0\" size=\"2\">\u5b66\u751f\u5404\u7c7b\u6210\u7ee9\u67e5\u8be2</font></span>' + scoreHTML; } } }";
				document.body.appendChild(a);
				a=document.getElementById("DataGrid1");
				if(null!=a){
					for(var e=0,f=0,c=1;c<a.rows.length;c++){
						var g=a.rows[c].cells[1].innerHTML.replace(/(<([^>]+)>)/gi,""),
						i=a.rows[c].cells[2].innerHTML.replace(/(<([^>]+)>)/gi,""),
						b=a.rows[c].cells[3].innerHTML.replace(/(<([^>]+)>)/gi,""),
						d=a.rows[c].cells[5].innerHTML.replace(/(<([^>]+)>)/gi,""),
						h=document.getElementById("DataGrid1").rows[c].insertCell(-1);
						if("\u516c\u9009\u8bfe"==i||-1!=g.indexOf("\u4f53\u8d28\u5065\u5eb7\u8bad\u7ec3")||-1!=g.indexOf("\u519b\u8bad")||"\u514d\u4fee"==b)
							h.innerHTML='<input type="checkbox" id="course'+c+'" onclick="javascript:calGPA(true);"/>';
						else{
							h.innerHTML='<input type="checkbox" id="course'+c+'" checked onclick="javascript:calGPA(true);"/>';
							if(isNaN(b))
								switch(b){
									case "\u4f18\u79c0":
										b=4.5;
										break;
									case "\u826f\u597d":
										b=3.5;
										break;
									case "\u4e2d\u7b49":
										b=2.5;
										break;
									case "\u53ca\u683c":
										b=1.5;
										break;
									default:
										b=0
								}
							else b=60<=b?(b-50)/10:0;
							console.log(d+"x"+b+"="+d*b);
							d*=1;
							e+=d;
							f+=d*b
						}
					}
					console.log(f+"/"+e+"="+ f/e);
					a=(f/e).toFixed(3);
					if(!isNaN(a))
						a='</br><font style="color:#FFFFFF;background-color:#006699">\u672c\u9875\u5e73\u5747\u7ee9\u70b9:'+a+"</font>",
						document.getElementById("Table3").rows[0].cells[0].innerHTML='<span id="Label1"><font color="#0000C0" size="2">\u5b66\u751f\u5404\u7c7b\u6210\u7ee9\u67e5\u8be2</font></span>'+a
				}
			
			}
			else if(-1!=a.indexOf("/stdgl/pjgl/Web_StdPG.aspx?kcjsid"))
				for(a=2;12>a;a++)
					document.getElementsByName("DG_GXK:_ctl"+a+":Cbo_BZ")[0].checked=!0
		}
	
	});
})();
